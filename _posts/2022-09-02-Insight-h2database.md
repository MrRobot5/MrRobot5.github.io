---
layout: post
title:  "Insight h2database ä¸“è¾‘â­â­â­"
date:   2022-09-02 18:17:54 +0800
categories: jekyll update2

---

# Insight h2database ä¸“è¾‘

> æœ¬æ–‡ä½œä¸º Code Insight ç›®å½•ï¼Œæ¢³ç† h2 æ•°æ®åº“çš„çŸ¥è¯†ç‚¹ä»¥åŠæ„Ÿå…´è¶£çš„å®žçŽ°ç»†èŠ‚ã€‚
> 
> ä½œä¸ºä¸€ä¸ªæ•™å­¦æ¼”ç¤ºç”¨çš„æ•°æ®åº“ï¼Œæ€§èƒ½ä¼˜åŒ–è‚¯å®šä¸æ˜¯å…¶ä¼˜åŠ¿ï¼Œé‡ç‚¹åœ¨åè®®ã€SQLè§„èŒƒå®žçŽ°çš„æ€è·¯å’Œè§£å†³æ–¹æ¡ˆä¸Šã€‚âŒ
> 
> **h2 æ•°æ®åº“æä¾›DBMS å®Œæ•´çš„å®žçŽ°ã€ä¸°å¯Œçš„ç‰¹æ€§å’Œå…¶ç®€ç»ƒçš„å®žçŽ°**ï¼Œé€šè¿‡äº†è§£å…¶è®¾è®¡æ€è·¯ï¼Œä¸¾ä¸€åä¸‰ï¼Œåœ¨æ—¥å¸¸å¼€å‘è®¾è®¡ã€MySQL æ•°æ®åº“æ·±åº¦ç ”ç©¶éƒ½æœ‰å€Ÿé‰´æ„ä¹‰ã€‚âœ”
> 
> æ ¸å¿ƒå®žçŽ°çš„åŽŸç†åˆ†æžä¼šæŒç»­æ›´æ–°ã€è¡¥å……é“¾æŽ¥ã€‚

## æ¦‚è§ˆðŸŽ¯

### â‘ ç®€ä»‹

h2 æ•°æ®åº“æ”¯æŒåµŒå…¥å¼ï¼ˆå¼€æºäº§å“ demo æ¼”ç¤ºï¼‰å’ŒæœåŠ¡å™¨æ¨¡å¼ï¼Œå¯ä»¥ä½¿ç”¨ç£ç›˜å­˜å‚¨ï¼ˆB æ ‘ç´¢å¼•å­˜å‚¨å¼•æ“Žã€æ—¥å¿—ç»“æž„å­˜å‚¨å¼•æ“Žï¼‰æˆ–å†…å­˜æ•°æ®åº“ï¼Œå¹¶æä¾›äº‹åŠ¡æ”¯æŒå’Œå¤šç‰ˆæœ¬å¹¶å‘æŽ§åˆ¶ï¼ˆMVCCï¼‰ã€‚

åŒæ—¶è¿˜æä¾›äº†ä¸€ä¸ªåŸºäºŽæµè§ˆå™¨çš„æŽ§åˆ¶å°åº”ç”¨ç¨‹åºï¼ˆJavaWebï¼‰ï¼Œæ”¯æŒåŠ å¯†æ•°æ®åº“å’Œå…¨æ–‡æœç´¢ï¼ˆbased on Apache Luceneï¼‰ç­‰æ‰©å±•ç‰¹æ€§ã€‚åŠŸèƒ½éžå¸¸ä¸°å¯Œï¼Œä½¿ç”¨Java ç¼–å†™ï¼Œå¯ä»¥ä½œä¸ºå­¦ä¹ æ•°æ®åº“åŽŸç†å’Œæž¶æž„çš„èŒƒä¾‹ã€‚

### â‘¡ç›¸å…³æŠ€æœ¯ç‚¹

1. æ•°æ®åº“æ–‡ä»¶åè®®å®žçŽ°
2. ç£ç›˜é¡µå­˜å‚¨å’Œç¼“å­˜äº¤äº’å®žçŽ°
3. SQL è¯­æ³•è§£æžå™¨ï¼ˆé€’å½’ä¸‹é™åˆ†æžå™¨ï¼‰
4. æœç´¢ç®—æ³•ï¼ˆB æ ‘ã€R-Treeã€LSMã€å…¨æ–‡æœç´¢ã€å¤šç»´æœç´¢ï¼‰
5. æ•°æ®å­˜å‚¨ç»“æž„å®žçŽ°
6. å¿«ç…§ã€checkpointã€MVCC å®žçŽ°
7. ANSI-SQL89 è§„èŒƒå®žçŽ°
8. JDBC åè®®å®žçŽ°
9. TCPServer å®žçŽ°
10. Http Web Server å®žçŽ°
11. JSP åè®®å®žçŽ°

### â‘¢å‚è€ƒä¿¡æ¯

1. [H2 Database å®˜ç½‘](https://h2database.com/html/main.html)

2. [H2 ä½¿ç”¨æ•™ç¨‹](https://h2database.com/html/tutorial.html) 10min å¸¦ä½ çŽ©è½¬ H2 æ•°æ®åº“ ðŸ˜€

3. [H2 æ”¯æŒçš„SQL è¯­æ³•](https://h2database.com/html/grammar.html) å¢žåˆ æ”¹æŸ¥ã€å­˜å‚¨è¿‡ç¨‹ã€è§¦å‘å™¨ç­‰ï¼Œå…¼å®¹ ANSI-SQL89 è§„èŒƒã€‚

4. [H2 ç‰¹æ€§ä»‹ç»å’ŒåŽŸç†](https://h2database.com/html/features.html) Code Insight ä¸»è¦å‚è€ƒèµ„æ–™

## æ ¸å¿ƒå®žçŽ°âœ¨

> ç›®å½•ç»“æž„å‚è€ƒ [å®˜ç½‘ä»‹ç»æž¶æž„](https://h2database.com/html/architecture.html) çš„Top-down Overviewã€‚
> 
> ç»“åˆå…³ç³»åž‹æ•°æ®åº“å’Œ DBMS ç›¸å…³çš„çŸ¥è¯†ç‚¹ï¼Œç†è®ºç»“åˆå®žé™…ï¼Œæ·±å…¥ç†è§£æ•°æ®åº“æ€æƒ³ã€‚

### â‘ JDBC driver.

> org.h2.Driver

### â‘¡Connection/session management.

> org.h2.engine.SessionRemote
> 
> å‚è€ƒ Database URL Overview URL è¿žæŽ¥å’Œé…ç½®ç¤ºä¾‹

### â‘¢SQL Parser.

> org.h2.command.Parser
> 
> SQL è¯­æ³•è§£é‡Šå™¨ä½¿ç”¨é€’å½’ä¸‹é™åˆ†æžå™¨ï¼ˆrecursive-descentï¼‰ï¼ŒæŒ‰ç…§è¯­æ³•è§„åˆ™è§£æžè¾“å…¥çš„æ–‡æœ¬ã€‚æœ‰æ€§èƒ½é—®é¢˜ï¼Œä¼˜ç‚¹æ˜¯æ˜“äºŽå®žçŽ°å’Œç†è§£ã€‚

### â‘£Command execution and planning.

> package org.h2.command.dml
> 
> org.h2.expression.Expression
> 
> h2 æ²¡æœ‰ç”ŸæˆæŸ¥è¯¢ IRï¼ˆä¸­é—´è¡¨ç¤ºï¼‰è¿™ä¸€ä¸­é—´æ­¥éª¤ï¼Œè€Œæ˜¯ç›´æŽ¥ç”Ÿæˆä¸€ä¸ªå‘½ä»¤æ‰§è¡Œå¯¹è±¡ã€‚ç„¶åŽå¯¹å‘½ä»¤å¯¹è±¡è¿›è¡Œä¸€äº›ä¼˜åŒ–æ­¥éª¤ï¼ˆorg.h2.expression.Expression#optimizeï¼‰ï¼Œç”Ÿæˆæ›´æœ‰æ•ˆçš„å‘½ä»¤ã€‚

[Insight H2 database auto increment](./2022-12-02-Insight-H2-database-auto-increment.md)

### â‘¤Table/Index/Constraints.

> org.h2.table.RegularTable
> 
> org.h2.mvstore.db.MVTable
> 
> org.h2.index.PageBtreeIndex
> 
> RegularTable é‡‡ç”¨å¸¸ç”¨çš„æ•°æ®è¡¨å®žçŽ°æ–¹æ¡ˆï¼Œå¸¸è§çš„B Tree ç´¢å¼•ç»“æž„ï¼Œèšé›†ç´¢å¼•æ•°æ®å­˜å‚¨ç­‰ã€‚
> 
> MVTable æ˜¯åŸºäºŽæ–°ä¸€ä»£çš„å­˜å‚¨å¼•æ“Ž MVStore å®žçŽ°çš„æ•°æ®è¡¨å®žçŽ°ã€‚

### â‘¥Undo log, redo log, and transactions layer.

> Undo log, æ’¤é”€æ—¥å¿—æ˜¯æ¯ä¸ªä¼šè¯ç‹¬ç«‹çš„ï¼Œç”¨äºŽå›žæ»šæ“ä½œæˆ–æ’¤é”€å¤±è´¥çš„æ›´æ”¹ã€‚
> 
> redo log, é‡åšæ—¥å¿—ä¹Ÿæ˜¯æ¯ä¸ªä¼šè¯ç‹¬ç«‹çš„ï¼Œç”¨äºŽåœ¨å´©æºƒåŽæ¢å¤æ•°æ®åº“ã€‚
> 
> transaction log, äº‹åŠ¡æ—¥å¿—æ˜¯åœ¨æ‰€æœ‰ä¼šè¯ä¹‹é—´å…±äº«çš„(MVCC)ï¼Œç”¨äºŽè®°å½•æ•°æ®åº“çš„æ‰€æœ‰æ›´æ”¹ã€‚

### â‘¦B-tree engine and page-based storage allocation.

> åŸºäºŽ B-tree çš„å­˜å‚¨å¼•æ“Žï¼Œä½¿ç”¨ç£ç›˜é¡µé¢ï¼ˆå—ï¼‰å­˜å‚¨æ•°æ®ã€‚
> 
> Bæ ‘æ˜¯ä¸€ç§æ ‘çŠ¶æ•°æ®ç»“æž„ï¼Œç”¨äºŽç»„ç»‡å’Œå­˜å‚¨æ•°æ®ï¼Œå¯ç”¨äºŽåœ¨å¤§é‡æ•°æ®é›†ä¸­å¿«é€ŸæŸ¥æ‰¾å’Œè®¿é—®æ•°æ®ã€‚é’ˆå¯¹ç£ç›˜å­˜å‚¨ä»‹è´¨ï¼Œå®žçŽ°æ•°æ®å¿«é€Ÿæ£€ç´¢å’Œæ›´æ–°ã€‚

[ç¬”è®° h2database BTree è®¾è®¡å®žçŽ°ä¸ŽæŸ¥è¯¢ä¼˜åŒ–æ€è€ƒ](./2023-06-06-Note-BTree-In-h2database.md)

### â‘§MVStore storage engine

> MVStore æ˜¯ä¸€ç§æŒä¹…åŒ–çš„ã€åŸºäºŽæ—¥å¿—ç»“æž„çš„é”®å€¼å­˜å‚¨ã€‚ç”¨ä½œæ–°ç‰ˆæœ¬ H2 çš„é»˜è®¤å­˜å‚¨å¼•æ“Žã€‚
> 
> H2 æ•°æ®åº“å®˜ç½‘ç‰¹æœ‰ä¸€ç« èŠ‚ç”¨æ¥æè¿° [MVStore](https://h2database.com/html/mvstore.html)ã€‚
> 
> è¿™ç§å¼•æ“Žå°†ä¿®æ”¹çš„æ•°æ®ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œç„¶åŽåœ¨ç´¯ç§¯è¶³å¤Ÿçš„ä¿®æ”¹åŽï¼Œå°†å®ƒä»¬ä¸€æ¬¡æ€§å†™å…¥ç£ç›˜ã€‚è¿™ç§æ–¹å¼å¯ä»¥æé«˜å†™å…¥æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯å¯¹äºŽä¸æ”¯æŒå°éšæœºå†™å…¥çš„æ–‡ä»¶ç³»ç»Ÿå’Œå­˜å‚¨ç³»ç»Ÿï¼ˆå¦‚Btrfsï¼‰ï¼Œä»¥åŠSSDã€‚
> 
> æ¯ä¸ªä¿®æ”¹é›†åˆç§°ä¸ºä¸€ä¸ªâ€œchunkâ€ï¼Œå…¶ä¸­åŒ…å«äº†æ‰€æœ‰è¢«ä¿®æ”¹çš„Bæ ‘çš„çˆ¶èŠ‚ç‚¹å’Œæ ¹èŠ‚ç‚¹ï¼Œä»¥åŠå…ƒæ•°æ®ã€‚
> 
> ä¸ºäº†é‡ç”¨ç£ç›˜ç©ºé—´ï¼Œä¼šåŽ‹ç¼©å…·æœ‰æœ€å°‘æ´»åŠ¨æ•°æ®çš„chunkã€‚ä¸Žä¼ ç»Ÿå­˜å‚¨å¼•æ“Žç›¸æ¯”ï¼Œè¿™ç§å¼•æ“Žæ›´ç®€å•ã€æ›´çµæ´»ï¼Œå¹¶ä¸”é€šå¸¸éœ€è¦æ›´å°‘çš„ç£ç›˜æ“ä½œã€‚

### â‘¨Filesystem abstraction.

> org.h2.store.FileStore
> 
> org.h2.mvstore.OffHeapStore
> 
> æ–‡ä»¶æŠ½è±¡å±‚ï¼Œæ–¹ä¾¿å­˜å‚¨å¼•æ“Žå±‚è¿›è¡Œæ“ä½œã€‚å°è£…äº†seekã€readFullyã€writeã€sync ç­‰æ–¹æ³•ï¼Œå±è”½äº†å…·ä½“å­˜å‚¨ï¼ˆä¹Ÿå¯ä»¥ä½¿ç”¨å †å¤–å­˜å‚¨ï¼‰çš„å®žçŽ°ç»†èŠ‚ã€‚
> 
> ByteBuffer.allocateDirect
