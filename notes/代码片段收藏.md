# 代码片段收藏

## Java

### 集合遍历删除

```java
/**
 * Remove a child object this object is tracing.
 * 
 * 对比 java.util.ArrayList#remove(java.lang.Object)。此方法更多在于并发控制
 */
protected void removeTrace(final AbandonedTrace trace) {
    synchronized(this.traceList) {
        final Iterator<WeakReference<AbandonedTrace>> iter = traceList.iterator();
        while (iter.hasNext()) {
            final WeakReference<AbandonedTrace> ref = iter.next();
            if (trace.equals(ref.get())) {
                iter.remove();
                break;
            } else if (ref.get() == null) {
                // Clean-up since we are here anyway
                iter.remove();
            }
        }
    }
}
```

### Crontab pattern

```java
import org.springframework.scheduling.support.CronSequenceGenerator;

final String cronExpression = "0 45 23 * * *";
final CronSequenceGenerator generator = new CronSequenceGenerator(cronExpression);
final Date nextExecutionDate = generator.next(new Date());
```



### 文本操作

#### mime.types.mapping 资源读取

```java
/**
 * 支持换行符文本读取和解析
 * @see javax.activation.MimetypesFileTypeMap#MimetypesFileTypeMap(java.io.InputStream)
 */
private void parse(BufferedReader buf_reader) throws IOException {
    String line = null;
    String prev = null;

    while(true) {
        while((line = buf_reader.readLine()) != null) {
            if (prev == null) {
                prev = line;
            } else {
                prev = prev + line;
            }

            int end = prev.length();
            // 如果以”\“结尾，此行内容没有结束。需要继续读取
            if (prev.length() > 0 && prev.charAt(end - 1) == '\\') {
                prev = prev.substring(0, end - 1);
            } else {
                this.parseEntry(prev);
                prev = null;
            }
        }

        // 剩余内容解析
        if (prev != null) {
            this.parseEntry(prev);
        }

        return;
    }
}
```

#### 命名转换

```java
/**
 * 字符串驼峰转下划线格式
 *
 * @param param 需要转换的字符串
 * @return 转换好的字符串
 * @see com.baomidou.mybatisplus.core.toolkit.StringUtils#camelToUnderline
 */
public static String camelToUnderline(String param) {
    if (isBlank(param)) {
        return EMPTY;
    }
    int len = param.length();
    StringBuilder sb = new StringBuilder(len);
    for (int i = 0; i < len; i++) {
        char c = param.charAt(i);
        if (Character.isUpperCase(c) && i > 0) {
            sb.append(UNDERLINE);
        }
        sb.append(Character.toLowerCase(c));
    }
    return sb.toString();
}
```

### 继承类的Bean Copy

```java
/**
 * 支持继承类的父类属性copy 的实现
 * org.apache.ibatis.reflection.property.PropertyCopier
 */
public final class PropertyCopier {

    private PropertyCopier() {
        // Prevent Instantiation of Static Class
    }

    public static void copyBeanProperties(Class < ? > type, Object sourceBean, Object destinationBean) {
        Class < ? > parent = type;
        // 递归查找指定type 所有的父类。破解getDeclaredFields 只能取到当前type 的范围限制。
        while (parent != null) {
            final Field[] fields = parent.getDeclaredFields();
            for (Field field: fields) {
                try {
                    field.setAccessible(true);
                    field.set(destinationBean, field.get(sourceBean));
                } catch (Exception e) {
                    // Nothing useful to do, will only fail on final fields, which will be ignored.
                }
            }
            parent = parent.getSuperclass();
        }
    }
}
```

### 方便的数据结构

#### LinkedMultiValueMap

```java
/**
 * Map<K, List<V>> 数据结构工具类，方便进行集合的数据操作。
 * org.springframework.util.LinkedMultiValueMap
 */
public void add(K key, V value) {
    List<V> values = this.targetMap.get(key);
    if (values == null) {
        values = new LinkedList<V>();
        this.targetMap.put(key, values);
    }
    values.add(value);
}
```

#### Multimap

```java
/**
 * Map<K, List<V>> 数据结构工具类，方便进行集合的数据操作。
 * 相比于LinkedMultiValueMap， Guava 提供的功能更加丰富
 * com.google.common.collect.Multimap
 */
ListMultimap<String, String> multimap = ArrayListMultimap.create();
```

### SQL 解析

```java
// Toolfunctions to start and use JSqlParser.
Statement stmt = CCJSqlParserUtil.parse(sql);
Select select = (Select) stmt;
```

```xml
<dependency>
    <groupId>com.github.jsqlparser</groupId>
    <artifactId>jsqlparser</artifactId>
    <version>1.0</version>
</dependency>
```

### 反射操作

#### 获取 Class 类名缩写

```java
/**
 * Return the short string name of a Java class in uncapitalized JavaBeans
 * property format. Strips the outer class name in case of an inner class.
 * @param clazz the class
 * @return the short name rendered in a standard JavaBeans property format
 * @see java.beans.Introspector#decapitalize(String)
 */
public static String getShortNameAsProperty(Class<?> clazz) {
    String shortName = ClassUtils.getShortName(clazz);
    int dotIndex = shortName.lastIndexOf('.');
    shortName = (dotIndex != -1 ? shortName.substring(dotIndex + 1) : shortName);
    return Introspector.decapitalize(shortName);
}
```

#### 实例属性操作

**SystemMetaObject**

```java
// @see org.apache.ibatis.reflection.SystemMetaObject
protected void setSqlSource(MappedStatement ms, SqlSource sqlSource) {
    MetaObject msObject = SystemMetaObject.forObject(ms);
    msObject.setValue("sqlSource", sqlSource);
}
```

#### 获取 Unsafe

```java
/**
 * attempt to access field Unsafe#theUnsafe
 * 
 * @see io.netty.util.internal.PlatformDependent0
 */
try {
    final Field unsafeField = Unsafe.class.getDeclaredField("theUnsafe");
    Throwable cause = ReflectionUtil.trySetAccessible(unsafeField, false);
    if (cause != null) {
        return cause;
    }
    // the unsafe instance
    return unsafeField.get(null);
} catch (NoSuchFieldException e) {
```

#### 获取接口泛型

```java
**
 * 提取泛型模型,多泛型的时候请将泛型T放在第一位
 * @see com.baomidou.mybatisplus.core.injector.AbstractSqlInjector#inspectInject
 * @param mapperClass mapper 接口
 * @return mapper 泛型
 */
protected Class<?> extractModelClass(Class<?> mapperClass) {
    Type[] types = mapperClass.getGenericInterfaces();
    ParameterizedType target = null;
    for (Type type : types) {
        if (type instanceof ParameterizedType) {
            Type[] typeArray = ((ParameterizedType) type).getActualTypeArguments();
            if (ArrayUtils.isNotEmpty(typeArray)) {
                for (Type t : typeArray) {
                    if (t instanceof TypeVariable || t instanceof WildcardType) {
                        break;
                    } else {
                        target = (ParameterizedType) type;
                        break;
                    }
                }
            }
            break;
        }
    }
    return target == null ? null : (Class<?>) target.getActualTypeArguments()[0];
}
```

#### 获取Class 对象-缓存

```java
// org.springframework.util.ClassUtils
(Class<? extends Annotation>) ClassUtils.forName("javax.inject.Named", cl)
```

#### 获取Method 反射-缓存

```java
/**
 * This variant retrieves {@link Class#getDeclaredMethods()} from a local cache
 * in order to avoid the JVM's SecurityManager check and defensive array copying.
 * @see org.springframework.util.ReflectionUtils
 */
private static Method[] getDeclaredMethods(Class<?> clazz) {
    Assert.notNull(clazz, "Class must not be null");
    Method[] result = declaredMethodsCache.get(clazz);
    if (result == null) {
        Method[] declaredMethods = clazz.getDeclaredMethods();
        // ...
        declaredMethodsCache.put(clazz, (result.length == 0 ? NO_METHODS : result));
    }
    return result;
}
```

#### 获取Classs 反射-缓存

```java
/**
 * easy mapping between property names and getter/setter methods.
 * @see org.apache.ibatis.reflection.DefaultReflectorFactory#findForClass
 */
public Reflector findForClass(Class<?> type) {
    if (classCacheEnabled) {
        Reflector cached = reflectorMap.get(type);
        if (cached == null) {
            cached = new Reflector(type);
            reflectorMap.put(type, cached);
        }
        return cached;
    } else {
        return new Reflector(type);
    }
}
```

### 属性配置

```java
// org.springframework.boot.autoconfigure.jdbc.DataSourceBuilder
private void bind(DataSource result) {
    MutablePropertyValues properties = new MutablePropertyValues(this.properties);
    new RelaxedDataBinder(result).withAlias("url", "jdbcUrl")
            .withAlias("username", "user").bind(properties);
}
```

### Java 框架

#### com.github.pagehelper

```java
public PageInfo<T> selectPage(PaginationInfo pgInfo, T t) {
    PageHelper.startPage(pgInfo.getPageNum(), pgInfo.getPageSize());
    List<T> lt = getMapper().getList(t);
    PageInfo<T> pageInfo = new PageInfo<T>(lt);
    return pageInfo;
}
```

#### spring-core 读取资源

```java
/**
 * The {@code Resource} to load the mapping file from.
 * @see org.springframework.mail.javamail.ConfigurableMimeFileTypeMap
 */
private Resource mappingLocation = new ClassPathResource("mime.types", getClass());
```

#### spring-aop

```java
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Pointcut;
import org.springframework.util.StopWatch;
import org.springframework.core.annotation.Order;

@Aspect
public class ProfilingAspect {

    @Around("methodsToBeProfiled()")
    public Object profile(ProceedingJoinPoint pjp) throws Throwable {
        StopWatch sw = new StopWatch(getClass().getSimpleName());
        try {
            sw.start(pjp.getSignature().getName());
            return pjp.proceed();
        } finally {
            sw.stop();
            System.out.println(sw.prettyPrint());
        }
    }

    @Pointcut("execution(public * foo..*.*(..))")
    public void methodsToBeProfiled(){}
}
```

## JS 脚本

### console 格式化

```javascript
// %c 用于传递 CSS 来格式化字符串。
// %d 将变量格式化为整数；
console.log(
  '%c I have %d %s',
  'color: green; background:black; font-size: 20pt',
  3,
  'Bikes!'
)
```

## 原生js 操作dom

```javascript
// 批量隐藏对应 Table 列
for (var j = 5; j < 16; j++) {
  let items = document.querySelectorAll(".el-table_1_column_" + j);
  for (var i = 0; i < items.length; i++) {
    console.log(i + "--" + items[i]);
    items[i].style.display = 'none'
  }
}
```

## Android

### 发送短信

```java
public void composeMmsMessage(String message, Uri attachment) {
    Intent intent = new Intent(Intent.ACTION_SENDTO);
    intent.setType(HTTP.PLAIN_TEXT_TYPE);
    intent.putExtra("sms_body", message);
    intent.putExtra(Intent.EXTRA_STREAM, attachment);
    if (intent.resolveActivity(getPackageManager()) != null) {
        startActivity(intent);
    }
}
```

## MySQL

```sql
-- 查询索引
show index from spm_chance
```
